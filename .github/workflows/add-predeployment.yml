name: "Add Pre-deployment Artifact"

on:
  # Allow calling from other workflows
  workflow_call:
    inputs:
      chain_id:
        description: "The chain ID for the pre-deployed network"
        required: true
        type: string
      rpc_url:
        description: "RPC URL to verify the deployment (optional)"
        required: false
        type: string
      skip_chainlist_check:
        description: "Skip chainlist verification"
        required: false
        type: boolean
        default: false
    outputs:
      success:
        description: "Whether the pre-deployment was added successfully"
        value: ${{ jobs.addPredeployment.outputs.success }}
      message:
        description: "Result message"
        value: ${{ jobs.addPredeployment.outputs.message }}
      pr_number:
        description: "The pull request number if created"
        value: ${{ jobs.addPredeployment.outputs.pr_number }}

  # Allow manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      chain_id:
        description: "The chain ID for the pre-deployed network"
        required: true
        type: string
      rpc_url:
        description: "RPC URL to verify the deployment (optional)"
        required: false
        type: string
      skip_chainlist_check:
        description: "Skip chainlist verification"
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  addPredeployment:
    runs-on: ubuntu-latest
    outputs:
      success: ${{ steps.add.outputs.success }}
      message: ${{ steps.add.outputs.message }}
      pr_number: ${{ steps.create-pr.outputs.pull-request-number }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install dependencies
        run: npm ci

      - name: Add pre-deployment artifact
        id: add
        env:
          CHAIN_ID: ${{ inputs.chain_id }}
          RPC: ${{ inputs.rpc_url }}
          SKIP_CHAINLIST_CHECK: ${{ inputs.skip_chainlist_check }}
          SUMMARY_FILE: summary.json
        run: |
          npm run add:predeployment || true
          echo "success=$(jq -r '.success' $SUMMARY_FILE)" >> $GITHUB_OUTPUT
          echo "message=$(jq -r '.commentOutput' $SUMMARY_FILE)" >> $GITHUB_OUTPUT

      - name: Check result
        if: steps.add.outputs.success != 'true'
        run: |
          echo "Failed to add pre-deployment: ${{ steps.add.outputs.message }}"
          exit 1

      - name: Create Pull Request
        id: create-pr
        if: steps.add.outputs.success == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat: add pre-deployment artifact for chain ${{ inputs.chain_id }}"
          title: "feat: Add pre-deployment artifact for chain ${{ inputs.chain_id }}"
          body: |
            ## Summary

            This PR adds the pre-deployment artifact for chain ID **${{ inputs.chain_id }}**.

            ### What is a pre-deployment?

            OP Stack networks and ZKsync based networks with the [EVM bytecode interpreter](https://docs.zksync.io/zksync-era/unique-features/evm-interpreter/evm-interpreter) include the Safe Singleton Factory as a pre-installed contract, meaning that there is no need to deploy it.

            ### Verification

            ${{ inputs.rpc_url && format('- ✅ Factory verified on-chain via RPC: `{0}`', inputs.rpc_url) || '- ⚠️ No RPC URL provided for on-chain verification' }}
            ${{ inputs.skip_chainlist_check && '- ⚠️ Chainlist verification was skipped' || '- ✅ Chain is listed in chainlist' }}

            ---
            *This PR was automatically created by the [Add Pre-deployment workflow](https://github.com/${{ github.repository }}/actions/workflows/add-predeployment.yml).*
          branch: "add-predeployment-${{ inputs.chain_id }}"
          delete-branch: true
          labels: |
            pre-deployment
            automated

      - name: Output PR info
        if: steps.create-pr.outputs.pull-request-number
        run: |
          echo "### ✅ Pull Request Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "PR #${{ steps.create-pr.outputs.pull-request-number }}: ${{ steps.create-pr.outputs.pull-request-url }}" >> $GITHUB_STEP_SUMMARY
